---
title: "Explore raw crossings"
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE)
```



```{r}

library(tidyverse)
library(ggnewscale)
library(here)
library(sf)
library(flextable)


source(here("code/utilities.R"))

# checking the results of get_rd_cross() from analysisXX_road_crossings.R ----
road_crossing_steps <- readRDS(here("data/road_crossing_steps_napa_sonoma"))
puma_steps <- readRDS(here("data/puma_steps"))
napa_sonoma_rds_utm <- readRDS(here("data/napa_sonoma_rds_utm"))

# boundaries of states in the united states
#states <- ne_states(iso_a2 = "US", returnclass = "sf") %>%
#  filter(iso_a2 == "US", postal %in% c("CA")) %>%
#  transmute(state = iso_3166_2)
# and county boundaries
study_area_counties <- readRDS("C:/Users/scott.jennings/OneDrive - Audubon Canyon Ranch/Projects/other_research/mt_lion_data_work/data/study_area_counties") %>% 
  st_transform(crs = 26910)
```

After basic data cleaning, the first major step in this analysis is to identify which mountain lion "steps" crossed roads. A step is simply the movement between 2 sequential GPS locations.



Road data are available for Napa County here: https://gisdata.countyofnapa.org/datasets/672af75a8edb4f3288efd41f092e3aae_0/explore and for Sonoma County here: https://gis-sonomacounty.hub.arcgis.com/datasets/8c533884059741bc85e943193837d414_0/explore

These GIS layers classify roads based on national standards (https://safety.fhwa.dot.gov/speedmgt/data_facts/docs/rd_func_class_1_42.pdf), and roads are separated into segments. Most road segments are local roads or other slow speed roads that are likely not the most risky for mountain lions to cross. 

```{r}

napa_sonoma_rds_utm %>% 
  group_by(class) %>% 
  summarise(num.segments = n()) %>% 
  ungroup() %>% 
  filter(num.segments > 0) %>% 
  mutate(puma.risk = ifelse(class %in% keep_road_classes, "higher", "lower")) %>% 
  ggplot() +
  geom_col(aes(y = fct_reorder(class, num.segments), x = num.segments, fill = puma.risk)) +
  labs(x = "Number of road segments",
       y = "Road class",
       fill = "Puma risk",
       title = "Road classes in Napa and Sonoma Counties") +
  theme_bw()

```

Eliminating these low risk roads greatly improves computing time for detecting which steps involved road crossings. In the map below the higher risk roads are colored by road class, and the lower risk roads are gray.
```{r}

ggplot() +
  geom_sf(data = filter(napa_sonoma_rds_utm, !class %in% keep_road_classes), color = "gray") +
  geom_sf(data = filter(napa_sonoma_rds_utm, class %in% keep_road_classes), aes(color = class)) +
  geom_sf(data = filter(study_area_counties, NAME %in% c("Napa", "Sonoma")), fill = NA) +
  coord_sf(datum = st_crs(26910)) +
  theme_bw() +
  labs(color = "Road class")

```

The mountain lion step data and road layer can then be combined to identify every step that involved a road crossing. The result is too detailed and covers too large an area to show for all mountain lions all at once, but we can zoom in on specific chunks of the data to view how the road-crossing classification worked. Here, we are zooming in on P1 while she was carrying collar #23163 in 2017-18. Here, the thicker colored lines are higher risk roads, the thinner colored lines are the mountain lion steps, and the thinner gray lines are the lower risk. Orange indicates where steps crossed road segments, and green indicates no crossing. (Note that some roads showing up a crossed without a corresponding mountain lion step are a relics of the filtering process)

```{r}



cat.collar = "P1_23163"

out_crossings <- full_join(road_crossing_steps, puma_steps) %>% 
  mutate(puma.crossed.road = !is.na(objectid)) %>% 
  filter(str_detect(step.id, cat.collar)) %>% 
  arrange(datetime.local)

bb.xmin = min(out_crossings$easting)
bb.xmax = max(out_crossings$easting)
bb.ymax = max(out_crossings$northing)
bb.ymin = min(out_crossings$northing)

#bb.xmin = 534000
#bb.xmax = 538000
#bb.ymax = 4250000
#bb.ymin = 4248000

out_road_slicer <- st_bbox(c(xmin = bb.xmin, xmax = bb.xmax,
                             ymax = bb.ymax, ymin = bb.ymin), crs = st_crs(26910)) %>% 
  st_as_sfc()


out_roads <- road_crossing_steps %>% 
  #filter(str_detect(step.id, "P1_23163")) %>% 
  data.frame() %>% 
  select(-geometry) %>% 
  full_join(napa_sonoma_rds_utm %>% filter(class %in% keep_road_classes)) %>% 
  st_as_sf() %>% 
  st_intersection(., out_road_slicer) %>% 
  mutate(road.was.crossed = !is.na(step.id))

out_road_labels <- out_roads %>% 
  group_by(label) %>% 
  filter(shape_leng == max(shape_leng)) %>% 
  ungroup() %>% 
  distinct(label, geometry)

out_roads_dropped <- napa_sonoma_rds_utm %>% 
  filter(!class %in% keep_road_classes) %>% 
  st_as_sf() %>% 
  st_intersection(., out_road_slicer)

my_colors <- RColorBrewer::brewer.pal(8, "Dark2")[7:8]

ggplot(out_roads)  +
  geom_sf(aes(color = road.was.crossed), linewidth = 1.5) + 
  scale_color_brewer(palette = 'Dark2') +
  geom_sf(data = out_roads_dropped, color = "gray")+
  #new_scale_color() +
  geom_segment(data = filter(out_crossings, (between(easting, bb.xmin, bb.xmax) & between(easting.end, bb.xmin, bb.xmax)) & 
                               (between(northing, bb.ymin, bb.ymax) & between(northing.end, bb.ymin, bb.ymax))), aes(x = easting, y = northing, xend = easting.end, yend = northing.end, color = puma.crossed.road)) +
  #scale_fill_manual(values = my_colors, labels = c(FALSE, TRUE)) +
  geom_sf_label(data = out_road_labels, aes(label = label), size = 2) +
  coord_sf(datum = st_crs(26910)) +
  theme_bw() +
  labs(x = "",
       y = "",
       color = "Road crossing occurred")

```
Zooming in farther near the Bennet Valley Rd label shows more detail.
```{r}



cat.collar = "P1_23163"

out_crossings <- full_join(road_crossing_steps, puma_steps) %>% 
  mutate(puma.crossed.road = !is.na(objectid)) %>% 
  filter(str_detect(step.id, cat.collar)) %>% 
  arrange(datetime.local)

bb.xmin = 534000
bb.xmax = 538000
bb.ymax = 4250000
bb.ymin = 4248000

out_road_slicer <- st_bbox(c(xmin = bb.xmin, xmax = bb.xmax,
                             ymax = bb.ymax, ymin = bb.ymin), crs = st_crs(26910)) %>% 
  st_as_sfc()


out_roads <- road_crossing_steps %>% 
  #filter(str_detect(step.id, "P1_23163")) %>% 
  data.frame() %>% 
  select(-geometry) %>% 
  full_join(napa_sonoma_rds_utm %>% filter(class %in% keep_road_classes)) %>% 
  st_as_sf() %>% 
  st_intersection(., out_road_slicer) %>% 
  mutate(road.was.crossed = !is.na(step.id))

out_road_labels <- out_roads %>% 
  group_by(label) %>% 
  filter(shape_leng == max(shape_leng)) %>% 
  ungroup() %>% 
  distinct(label, geometry)

out_roads_dropped <- napa_sonoma_rds_utm %>% 
  filter(!class %in% keep_road_classes) %>% 
  st_as_sf() %>% 
  st_intersection(., out_road_slicer)

my_colors <- RColorBrewer::brewer.pal(8, "Dark2")[7:8]

ggplot(out_roads)  +
  geom_sf(aes(color = road.was.crossed), linewidth = 1.5) + 
  scale_color_brewer(palette = 'Dark2') +
  geom_sf(data = out_roads_dropped, color = "gray")+
  #new_scale_color() +
  geom_segment(data = filter(out_crossings, (between(easting, bb.xmin, bb.xmax) & between(easting.end, bb.xmin, bb.xmax)) & 
                               (between(northing, bb.ymin, bb.ymax) & between(northing.end, bb.ymin, bb.ymax))), aes(x = easting, y = northing, xend = easting.end, yend = northing.end, color = puma.crossed.road)) +
  #scale_fill_manual(values = my_colors, labels = c(FALSE, TRUE)) +
  geom_sf_label(data = out_road_labels, aes(label = label), size = 2) +
  coord_sf(datum = st_crs(26910)) +
  theme_bw() +
  labs(x = "",
       y = "",
       color = "Road crossing occurred")

```


```{r}
step_summary <- full_join(road_crossing_steps, puma_steps) %>% 
  mutate(puma.crossed.road = ifelse(!is.na(objectid), "crossed", "not.crossed")) %>% 
  group_by(animal.id, puma.crossed.road) %>% 
  summarise(num.steps = n()) %>% 
  ungroup() %>% 
  data.frame() %>% 
  select(-geometry) %>% 
  pivot_wider(id_cols = animal.id, names_from = puma.crossed.road, values_from = num.steps) %>% 
  mutate(per.steps = 100 * (crossed/(crossed + not.crossed)),
         per.steps = round(per.steps, 2)) %>% 
  arrange(-per.steps)
```


Across all mountain lions, of `r nrow(puma_steps)` total steps, `r nrow(road_crossing_steps)`, (`r round(100 * (nrow(road_crossing_steps)/nrow(puma_steps)), 2)`%) crossed roads. Among individual mountain lions between `r min(step_summary$per.steps)`-`r max(step_summary$per.steps)`% of the steps crossed roads.

```{r}

step_summary %>% 
  flextable::flextable() %>% 
  flextable::set_header_labels(animal.id = "Animal ID",
                               crossed = "Crossed roads",
                               not.crossed = "Didn't cross roads",
                               per.steps = "% of steps crossing roads") %>% 
  align(j = 2:4, align = "center", part = "all") %>% 
  autofit()

```




Road crossing steps generally covered more distance than non-road crossing steps. A strong majority of non-crossing steps were less than about 250 m, whereas most crossing steps were 500-2000 m. This could mean that mountain lions are travelling faster/farther when they are crossing roads. Additionally, because of the relatively high density of roads in Napa and Sonoma Counties, it could also mean that these mountain lions may not be able to travel larger distances without encountering roads.
```{r}
out_crossings %>% 
  ggplot() +
  geom_density(aes(x = step.dist, color = puma.crossed.road)) +
  theme_bw() +
  labs(x = "Step length (m)",
       y = "Proportion of steps",
       color = "Road crossing occurred")

```

Most of the road crossings happened at night, as expected based on likely traffic patterns and mountain lion ecology. Although non-crossing steps were relatively evenly distributed through the day, it is important to note that this does not represent constant activity (step lengths) through the day.
```{r}

out_crossings %>% 
  ggplot() +
  geom_density(aes(x = hour(datetime.local), color = puma.crossed.road)) +
  theme_bw() +
  labs(x = "Hour of day",
       y = "Proportion of steps",
       color = "Road crossing occurred")

```

Combining step length and hour of day reveals that both crossing and non-crossing steps were shorter during daytime, indicating generally less movement during daytime. Interestingly, this plot shows even stronger that mountain lions avoided crossing roads during daytime as there were 0 crossing steps during most daylight hours. This plot also shows that there were some long non-crossing steps
```{r}
out_crossings %>% 
  mutate(hour = hour(datetime.local)) %>% 
  ggplot() +
  geom_boxplot(aes(x = as.factor(hour), y = step.dist, color = factor(puma.crossed.road))) +
  #stat_smooth(aes(x = hour, y = step.dist, color = factor(puma.crossed.road))) +
  theme_bw() +
  labs(y = "Step length (m)",
       x = "Hour of day",
       color = "Road crossing occurred")





```


If we consider only the steps that covered at least 1000 m, we see that there were actually more non-crossing steps than crossing steps across all hours of the day. This suggests that lions were indeed moving faster and farther than when they crossed roads, not just that they always tend to cross roads when they make longer steps. Indeed, mountain lions did make long non-crossing steps even in the middle of the day.

```{r}
out_crossings %>% 
  filter(step.dist > 1000) %>% 
  mutate(hour = hour(datetime.local)) %>% 
  group_by(hour, puma.crossed.road) %>% 
  summarise(num.steps = n()) %>% 
  ungroup() %>% 
  ggplot() +
  geom_col(aes(x = as.factor(hour), y = num.steps, fill = factor(puma.crossed.road)), position = position_dodge2(preserve = "single")) +
  #stat_smooth(aes(x = hour, y = step.dist, color = factor(puma.crossed.road))) +
  theme_bw() +
  labs(title = "Number of steps covering >1000 m",
       y = "# steps",
       x = "Hour of day",
       fill = "Road crossing occurred")

```



